<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HCI Study - Results</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
        /* some extra styles for this page */
        .comparison-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 40px;
        }

        .stat-box {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1a1a2e;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
            margin-top: 4px;
        }

        .winner {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        }

        .export-btns {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .export-btn {
            padding: 10px 20px;
            background: #4a90d9;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .export-btn:hover {
            background: #357abd;
        }

        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .chart-placeholder {
            background: #f0f0f0;
            height: 200px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            margin: 20px 0;
        }

        .bar-chart {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 40px;
            height: 200px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 20px 0;
        }

        .bar-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .bar {
            width: 80px;
            background: #4a90d9;
            border-radius: 4px 4px 0 0;
            transition: height 0.5s ease;
        }

        .bar.ui-a {
            background: #e63946;
        }

        .bar.ui-b {
            background: #28a745;
        }

        .bar-label {
            font-weight: 600;
            color: #333;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .delete-btn:hover {
            background: #c82333;
        }

        .data-table th:last-child,
        .data-table td:last-child {
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="results-container">
        <a href="index.html" class="back-btn">‚Üê Back to Home</a>

        <div class="results-header">
            <h1>Test Results</h1>
            <p>UI-A (Classic) vs UI-B (Focus Frame) comparison</p>
        </div>

        <!-- export buttons -->
        <div class="export-btns">
            <button class="export-btn" onclick="exportResultsAsJSON()">Download JSON</button>
            <button class="export-btn" onclick="exportResultsAsCSV()">Download CSV</button>
            <button class="clear-btn" onclick="handleClear()">Clear Data</button>
        </div>

        <!-- summary cards -->
        <div class="comparison-section" id="comparisonSection">
            <!-- will be filled by js -->
        </div>

        <!-- visual comparison -->
        <div class="result-card">
            <h3>Reading Time Comparison</h3>
            <div class="bar-chart" id="timeChart">
                <div class="bar-wrapper">
                    <div class="bar ui-a" id="barA" style="height: 0px;"></div>
                    <span class="bar-label">UI-A</span>
                    <span id="timeA">-</span>
                </div>
                <div class="bar-wrapper">
                    <div class="bar ui-b" id="barB" style="height: 0px;"></div>
                    <span class="bar-label">UI-B</span>
                    <span id="timeB">-</span>
                </div>
            </div>
        </div>

        <!-- raw data table -->
        <div class="result-card">
            <h3>All Test Data</h3>
            <div id="dataTableContainer">
                <!-- table goes here -->
            </div>
        </div>
    </div>

    <script src="tracking.js"></script>
    <script>
        // global variable to store all results with their Firebase keys
        var allResults = [];
        var resultKeys = {}; // maps sessionId to Firebase key

        // load and display results when page opens
        document.addEventListener('DOMContentLoaded', function() {
            loadResults();
        });

        function loadResults() {
            // show loading message
            document.getElementById('dataTableContainer').innerHTML = '<p style="text-align:center;">Loading data...</p>';

            // try to load from Firebase first
            if (typeof firebase !== 'undefined' && firebaseReady && database) {
                database.ref('results').once('value')
                    .then(function(snapshot) {
                        var data = snapshot.val();
                        allResults = [];
                        resultKeys = {};

                        if (data) {
                            // convert object to array and store keys
                            Object.keys(data).forEach(function(key) {
                                var item = data[key];
                                item._firebaseKey = key; // store the key with the item
                                allResults.push(item);
                                if (item.sessionId) {
                                    resultKeys[item.sessionId] = key;
                                }
                            });
                        }

                        // sort by date (newest first)
                        allResults.sort(function(a, b) {
                            return new Date(b.completedAt) - new Date(a.completedAt);
                        });

                        displayAllData();
                    })
                    .catch(function(err) {
                        console.warn('Firebase read failed, using localStorage:', err);
                        allResults = getResults();
                        displayAllData();
                    });
            } else {
                // fallback to localStorage
                allResults = getResults();
                displayAllData();
            }
        }

        function displayAllData() {
            if (allResults.length === 0) {
                showNoData();
                return;
            }

            // calculate stats from allResults
            var stats = calculateStats(allResults);

            // display comparison cards
            displayComparison(stats);

            // display chart
            displayChart(stats);

            // display table
            displayTable(allResults);
        }

        function calculateStats(results) {
            var uiA = results.filter(function(r) { return r.uiVersion === 'A'; });
            var uiB = results.filter(function(r) { return r.uiVersion === 'B'; });

            function avg(arr, key) {
                if (arr.length === 0) return 0;
                var sum = arr.reduce(function(acc, item) {
                    return acc + (item[key] || 0);
                }, 0);
                return Math.round(sum / arr.length);
            }

            return {
                uiA: {
                    count: uiA.length,
                    avgTimeSec: avg(uiA, 'readingTimeSec'),
                    avgScroll: avg(uiA, 'maxScrollDepth')
                },
                uiB: {
                    count: uiB.length,
                    avgTimeSec: avg(uiB, 'readingTimeSec'),
                    avgScroll: avg(uiB, 'maxScrollDepth')
                }
            };
        }

        function showNoData() {
            document.getElementById('comparisonSection').innerHTML = `
                <div class="no-data" style="grid-column: span 2;">
                    <h3>No data yet</h3>
                    <p>Return to the home page and select a UI to test.</p>
                </div>
            `;

            document.getElementById('dataTableContainer').innerHTML = `
                <p class="no-data">No saved test results found.</p>
            `;
        }

        function displayComparison(stats) {
            var html = '';

            // UI-A card
            html += `
                <div class="result-card ui-a">
                    <h3>UI-A (Classic Design)</h3>
                    <div class="stat-box">
                        <div class="stat-value">${stats.uiA.count}</div>
                        <div class="stat-label">Test Count</div>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Avg. Reading Time</span>
                        <span class="metric-value">${formatTime(stats.uiA.avgTimeSec)}</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Avg. Scroll Depth</span>
                        <span class="metric-value">${stats.uiA.avgScroll}%</span>
                    </div>
                </div>
            `;

            // UI-B card
            var betterTime = stats.uiB.avgTimeSec > stats.uiA.avgTimeSec;
            html += `
                <div class="result-card">
                    <h3>UI-B (Focus Frame)</h3>
                    <div class="stat-box ${betterTime ? 'winner' : ''}">
                        <div class="stat-value">${stats.uiB.count}</div>
                        <div class="stat-label">Test Count</div>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Avg. Reading Time</span>
                        <span class="metric-value">${formatTime(stats.uiB.avgTimeSec)}</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Avg. Scroll Depth</span>
                        <span class="metric-value">${stats.uiB.avgScroll}%</span>
                    </div>
                </div>
            `;

            document.getElementById('comparisonSection').innerHTML = html;
        }

        function displayChart(stats) {
            var maxTime = Math.max(stats.uiA.avgTimeSec, stats.uiB.avgTimeSec, 1);
            var maxHeight = 150; // max bar height in px

            var heightA = (stats.uiA.avgTimeSec / maxTime) * maxHeight;
            var heightB = (stats.uiB.avgTimeSec / maxTime) * maxHeight;

            // animate bars after short delay
            setTimeout(function() {
                document.getElementById('barA').style.height = heightA + 'px';
                document.getElementById('barB').style.height = heightB + 'px';
            }, 100);

            document.getElementById('timeA').textContent = formatTime(stats.uiA.avgTimeSec);
            document.getElementById('timeB').textContent = formatTime(stats.uiB.avgTimeSec);
        }

        function displayTable(results) {
            if (results.length === 0) {
                document.getElementById('dataTableContainer').innerHTML = '<p>No data</p>';
                return;
            }

            var html = '<table class="data-table">';

            // header
            html += '<tr>';
            html += '<th>Participant</th>';
            html += '<th>UI</th>';
            html += '<th>Time</th>';
            html += '<th>Scroll %</th>';
            html += '<th>Date</th>';
            html += '<th>Action</th>';
            html += '</tr>';

            // rows
            results.forEach(function(r, index) {
                var time = r.readingTimeSec || 0;
                var scroll = r.maxScrollDepth || 0;
                var pid = r.participantId || r.odsjajdid || '-';
                var ui = r.uiVersion || '?';
                var date = r.completedAt || r.finishedAt || '-';
                var firebaseKey = r._firebaseKey || '';

                // format date nicely
                if (date !== '-') {
                    var d = new Date(date);
                    date = d.toLocaleDateString('en-US') + ' ' + d.toLocaleTimeString('en-US');
                }

                html += '<tr>';
                html += '<td>' + pid + '</td>';
                html += '<td>' + ui + '</td>';
                html += '<td>' + formatTime(time) + '</td>';
                html += '<td>' + scroll + '%</td>';
                html += '<td>' + date + '</td>';
                html += '<td><button class="delete-btn" onclick="deleteResult(\'' + firebaseKey + '\', ' + index + ')">Delete</button></td>';
                html += '</tr>';
            });

            html += '</table>';

            document.getElementById('dataTableContainer').innerHTML = html;
        }

        // delete a single result
        function deleteResult(firebaseKey, index) {
            var item = allResults[index];
            var confirmMsg = 'Are you sure you want to delete this record?\n\nParticipant: ' + (item.participantId || '-') + '\nUI: ' + (item.uiVersion || '?');

            if (!confirm(confirmMsg)) {
                return;
            }

            // delete from Firebase
            if (firebaseKey && firebaseReady && database) {
                database.ref('results/' + firebaseKey).remove()
                    .then(function() {
                        console.log('Deleted from Firebase:', firebaseKey);
                        // reload data
                        loadResults();
                    })
                    .catch(function(err) {
                        console.error('Firebase delete failed:', err);
                        alert('Delete failed: ' + err.message);
                    });
            } else {
                // fallback: remove from local array and localStorage
                allResults.splice(index, 1);
                localStorage.setItem('hci_study_results', JSON.stringify(allResults));
                displayAllData();
            }
        }

        function formatTime(secs) {
            if (!secs) return '00:00';
            var m = Math.floor(secs / 60);
            var s = secs % 60;
            return String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
        }

        function handleClear() {
            if (confirm('Are you sure you want to delete all data?')) {
                clearResults();
                loadResults();
                alert('Data cleared.');
            }
        }

        // override export functions to use Firebase data
        function exportResultsAsJSON() {
            if (allResults.length === 0) {
                alert('No data to export');
                return;
            }

            var exportData = {
                results: allResults,
                exportedAt: new Date().toISOString(),
                summary: calculateStats(allResults)
            };

            var jsonStr = JSON.stringify(exportData, null, 2);
            var blob = new Blob([jsonStr], { type: 'application/json' });
            var url = URL.createObjectURL(blob);

            var link = document.createElement('a');
            link.href = url;
            link.download = 'hci_study_data_' + Date.now() + '.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function exportResultsAsCSV() {
            if (allResults.length === 0) {
                alert('No data to export');
                return;
            }

            var headers = ['participantId', 'uiVersion', 'readingTimeSec', 'maxScrollDepth', 'sidebarClicks', 'completedAt'];
            var csvLines = [];
            csvLines.push(headers.join(','));

            allResults.forEach(function(r) {
                var row = headers.map(function(h) {
                    var val = r[h];
                    if (val === null || val === undefined) return '';
                    var str = String(val);
                    if (str.indexOf(',') >= 0 || str.indexOf('"') >= 0) {
                        str = '"' + str.replace(/"/g, '""') + '"';
                    }
                    return str;
                });
                csvLines.push(row.join(','));
            });

            var csvContent = csvLines.join('\n');
            var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            var url = URL.createObjectURL(blob);

            var link = document.createElement('a');
            link.href = url;
            link.download = 'hci_study_results_' + Date.now() + '.csv';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
